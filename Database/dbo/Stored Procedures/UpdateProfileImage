
CREATE PROCEDURE [dbo].[uspUpdateUserProfileImg]
@Id INT,    
@UserPhoto varbinary(max),
@AvatarExt varchar(15),
@UserCode VARCHAR(50),
@CreatedOn DATETIME     
    
AS    
 BEGIN    
    BEGIN TRANSACTION;          
     SAVE TRANSACTION MySavePoint;            
      BEGIN TRY   
        BEGIN                     
		  UPDATE KMTUserRegistration 
		  SET UserPhoto = @UserPhoto, 
		  AvatarExt = @AvatarExt,
		  ImgStatus = 0  
		  WHERE Id = @Id   

		  DEClARE @UserName VARCHAR(50) = NULL
		  SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserCode = @UserCode )
		  INSERT INTO KMTNotification(
		  RoleId,
		  UserCode,
		  IsAdminFlag,
          IsUserFlag,
          IsFacilitatorFlag,
		  Identifier,
		  AdminDescripation,
		  UserDescripation,
		  CreatedOn)

   		  VALUES(
		  '1,10,12',
		  @UserCode,
		  0,
		  0,
		  0,
		  'ProfilePicApproval',
		  '<b>' + @UserName + '</b> has uploaded new profile picture',
		  'Your profile picture has been uploaded successfully',
		  @CreatedOn)  
       END     
      END TRY    
    BEGIN CATCH    
      IF @@TRANCOUNT > 0          
     BEGIN          
            ROLLBACK TRANSACTION MySavePoint;           
        END    
         END CATCH    
    COMMIT TRANSACTION    
 END
GO
