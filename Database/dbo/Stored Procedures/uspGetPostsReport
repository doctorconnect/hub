
CREATE PROCEDURE [dbo].[uspGetPostsReport]        
(      
@StartDate DateTime,      
@EndDate DateTime,      
@Criteria Varchar(50),
@Capid int,
@CapText Varchar(10)
)      
AS 
 IF @CapText IS NULL 
 BEGIN             
BEGIN       
 IF @Criteria='Month-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(YEAR, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1  and CapId = @Capid  
   GROUP BY DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate)      
 END    
 ELSE IF @Criteria='Week-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(YEAR, PostedDate), ' Week', DATEPART(WEEK, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1   and CapId = @Capid  
   GROUP BY DATEPART(WEEK, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(WEEK, PostedDate)      
 END    
 ELSE IF @Criteria='Day-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(DAY, PostedDate),'/',DATEPART(YEAR, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1   and CapId = @Capid 
   GROUP BY DATEPART(DAY, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(DAY, PostedDate)    
 END    
 ELSE    
 BEGIN    
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(DAY, PostedDate),'/',DATEPART(YEAR, PostedDate), ' ',DATEPART(HOUR, PostedDate), ':00')  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1  and CapId = @Capid   
   GROUP BY DATEPART(HOUR, PostedDate),    
     DATEPART(DAY, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)    
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(DAY, PostedDate), DATEPART(HOUR, PostedDate)    
 END     
END
END
 IF @CapText='ALL'
 BEGIN 
 BEGIN 
  IF @Criteria='Month-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(YEAR, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1  
   GROUP BY DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate)      
 END    
 ELSE IF @Criteria='Week-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(YEAR, PostedDate), ' Week', DATEPART(WEEK, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1    
   GROUP BY DATEPART(WEEK, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(WEEK, PostedDate)      
 END    
 ELSE IF @Criteria='Day-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(DAY, PostedDate),'/',DATEPART(YEAR, PostedDate))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1   
   GROUP BY DATEPART(DAY, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)     
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(DAY, PostedDate)    
 END    
 ELSE    
 BEGIN    
   SELECT     
   CONCAT(DATEPART(MONTH, PostedDate),'/',DATEPART(DAY, PostedDate),'/',DATEPART(YEAR, PostedDate), ' ',DATEPART(HOUR, PostedDate), ':00')  AS Interval,     
   COUNT(*) AS Utilization      
   FROM Posts             
   WHERE  PostedDate>=@StartDate AND PostedDate<=@EndDate  +1  
   GROUP BY DATEPART(HOUR, PostedDate),    
     DATEPART(DAY, PostedDate),    
     DATEPART(MONTH, PostedDate),    
     DATEPART(YEAR, PostedDate)    
   ORDER BY DATEPART(YEAR, PostedDate), DATEPART(MONTH, PostedDate), DATEPART(DAY, PostedDate), DATEPART(HOUR, PostedDate)    
 END   
 END
 END 
GO
