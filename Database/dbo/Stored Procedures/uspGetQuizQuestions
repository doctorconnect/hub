
CREATE PROCEDURE [dbo].[uspGetQuizQuestions]                  
   (  
   @CapabilitiesId int,  
   @IsAdmin int  
   )    
  AS      
      BEGIN      
      BEGIN TRANSACTION;            
      SAVE TRANSACTION MySavePoint;              
       BEGIN TRY     
        BEGIN    
	     IF(@IsAdmin=0) 
		 BEGIN  
      SELECT
	  Q.QuestionID,
	  Q.QuestionText,
	  Q.QuizID,
	  T.QuizName,
	  A.AnswerText,
	  c.ChoiceText,
	  c.ChoiceID
	   into #temp1 FROM [KMTQuestions] Q join [KMTQuiz] T on  Q.QuizID=T.QuizID 
	   join [KMTAnswers] A on a.QuestionID=q.QuestionID
	   join [KMTChoices] C on c.QuestionID = q.QuestionID
	    where T.IsActive ='1' 
		AND T.CapId = @CapabilitiesId

SELECT QuestionID,QuestionText,QuizID,QuizName,AnswerText,
			 ChoiceText = STUFF(
             (SELECT '/'+ ChoiceText
              FROM #temp1 t1
              WHERE t1.QuestionID = t2.QuestionId
              FOR XML PATH (''))
             , 1, 1, ''), ChoiceID = STUFF(
             (SELECT  '/'+ str(ChoiceID) 
              FROM #temp1 t1
              WHERE t1.QuestionID = t2.QuestionId
              FOR XML PATH (''))
             , 1, 1, '') 
			 from #temp1 t2 
     group by QuestionID,QuestionText,QuizID,QuizName,AnswerText;
    drop table #temp1
     END 
	   IF(@IsAdmin>0) 
		 BEGIN  
      SELECT
	  Q.QuestionID,
	  Q.QuestionText,
	  Q.QuizID,
	  T.QuizName,
	  A.AnswerText,
	  c.ChoiceText,
	  c.ChoiceID
	   into #temp2 FROM [KMTQuestions] Q join [KMTQuiz] T on  Q.QuizID=T.QuizID 
	   join [KMTAnswers] A on a.QuestionID=q.QuestionID
	   join [KMTChoices] C on c.QuestionID = q.QuestionID
	    where T.IsActive ='1'
		
SELECT QuestionID,QuestionText,QuizID,QuizName,AnswerText,
			 ChoiceText = STUFF(
             (SELECT '/'+ ChoiceText
              FROM #temp2 t1
              WHERE t1.QuestionID = t2.QuestionId
              FOR XML PATH (''))
             , 1, 1, ''), ChoiceID = STUFF(
             (SELECT  '/'+ str(ChoiceID) 
              FROM #temp2 t1
              WHERE t1.QuestionID = t2.QuestionId
              FOR XML PATH (''))
             , 1, 1, '') 
			 from #temp2 t2 
     group by QuestionID,QuestionText,QuizID,QuizName,AnswerText;
    drop table #temp2
     END 
         END         
      END TRY      
    BEGIN CATCH      
      IF @@TRANCOUNT > 0            
     BEGIN            
            ROLLBACK TRANSACTION MySavePoint;             
        END      
         END CATCH      
    COMMIT TRANSACTION      
 END
GO
