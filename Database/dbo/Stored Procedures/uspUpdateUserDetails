
CREATE PROCEDURE [dbo].[uspUpdateUserDetails]  
@Id INT,      @RoleId INT,      @LOBId INT,		@BusinessSegmentId INT,			@CapabilitiesId INT,		@IsActive BIT,			@UserCode VARCHAR(50),			@UserName VARCHAR(50),
@ModifiedOn DATETIME,			@AdminUser VARCHAR(100) = NULL,			@Status INT = 0         
AS      
 BEGIN      
    BEGIN TRANSACTION;            
     SAVE TRANSACTION MySavePoint;              
      BEGIN TRY     
		IF(@Status = 0)    
		BEGIN                       a
			UPDATE KMTUserRegistration SET 	RoleId = @RoleId,				BusinessSegmentId = @BusinessSegmentId,		CapabilitiesId = @CapabilitiesId, 			LOBId = @LOBId, 			IsActive = @IsActive 			WHERE Id = @Id
			INSERT INTO KMTNotification(			RoleId,			UserCode,			IsAdminFlag,			IsUserFlag,			IsFacilitatorFlag,			Identifier,			AdminDescripation,			UserDescripation,			CreatedOn)
			VALUES(			'1,10,12',			@UserCode,			0,			0,			0,			'UserAccess',			'<b>'+ @AdminUser + '</b> has changed access of <b>' + @UserName + '</b> successfully',
			'Your KMT access has been changed by <b>'+ @AdminUser + '</b>',			@ModifiedOn)  
		END    
    ELSE    
	  BEGIN    
			UPDATE KMTUserRegistration SET 			RoleId = @RoleId , 			LOBId = @LOBId, 			BusinessSegmentId = @BusinessSegmentId, 			CapabilitiesId = @CapabilitiesId, 			Status = 5, 		IsActive = 1 
			WHERE Id = @Id   
			UPDATE KMTNotification SET			RoleId = 1 ,			IsAdminFlag = 0,			IsUserFlag = 0,			IsFacilitatorFlag = 0,			Identifier = 'User-Reregisteration',
			AdminDescripation = '<b>' + @UserName + '</b> has requested to access KMT, waiting for approval',			CreatedOn = @ModifiedOn
			WHERE UserCode = @UserCode AND Identifier = 'UserRegisteration' 
     END      
      END TRY      
   BEGIN CATCH      
      IF @@TRANCOUNT > 0            
        BEGIN            
            ROLLBACK TRANSACTION MySavePoint;             
        END      
    END CATCH      
    COMMIT TRANSACTION      
 END
GO
