
CREATE PROCEDURE [dbo].[uspSubmitUserRequest]    
(                                    
 @UserCode VARCHAR(50),                                                        
 @UserNTID VARCHAR(50),                                                     
 @UserEmail VARCHAR(50),                                              
 @UserName VARCHAR(50),                                          
 @ManagerCode VARCHAR(50),                                          
 @ManagerEmail VARCHAR(50),                                          
 @ManagerName VARCHAR(50),                                                       
 @ManagerNTID VARCHAR(50),     
 @RoleId INT,     
 @BusinessSegmentId INT,  
 @CapabilitiesId INT,  
 @LOBId INT,  
 @Status INT,                                                    
 @IsActive BIT,                                                        
 @CreatedBy VARCHAR(50),                                                        
 @CreatedOn DATETIME,   
 @UserPhoto varbinary(max),  
 @AvatarExt VARCHAR(50),
 @Points INT                                  
)                                                        
AS                                                        
BEGIN          
    BEGIN TRANSACTION;        
      SAVE TRANSACTION MySavePoint;          
   BEGIN TRY                    
  INSERT INTO KMTUserRegistration(  
    UserCode,                                                        
    UserNTID,                                                     
    UserEmail,                                              
    UserName,                                          
    ManagerCode,                                          
    ManagerEmail,                                          
    ManagerName,                                                       
    ManagerNTID,     
    RoleId,    
    BusinessSegmentId,  
    CapabilitiesId,  
    LOBId,    
    [Status],                                                    
    IsActive,                                                        
    CreatedBy,                                                        
    CreatedOn,                                  
    ModifiedBy,                                  
    ModifiedOn,  
    UserPhoto,AvatarExt)                                                       
                                                      
    VALUES (                                  
    @UserCode,                                                        
    @UserNTID,                                                     
    @UserEmail,                                              
    @UserName,                                          
    @ManagerCode,                                          
    @ManagerEmail,                                          
    @ManagerName,                                                       
    @ManagerNTID,     
    @RoleId,  
    @BusinessSegmentId,  
    @CapabilitiesId,  
    @LOBId,    
    @Status,                                                    
    @IsActive,                                                        
    @CreatedBy,                                                        
    @CreatedOn,                              
    NULL,NULL,  
    @UserPhoto,@AvatarExt) ;   
	
  INSERT INTO KMTPointEarnSystem ( Points,[Pes_Id], Pes_type,Pes_by,Pes_On) VALUES (@Points,@RoleId,'Registration',@CreatedBy,@CreatedOn);	                                                        
        
    INSERT INTO KMTNotification(  
    RoleId,  
    UserCode,  
    IsAdminFlag,  
    IsUserFlag,  
    IsFacilitatorFlag,  
    Identifier,  
    AdminDescripation,  
    UserDescripation,  
    CreatedOn  
    )  
    VALUES(  
    1,  
    @UserCode,  
    0,  
    0,  
    0,  
    'UserRegisteration',  
    '<b>' + @UserName + '</b> has requested to access KMT, waiting for approval',  
    NULL,  
    @CreatedOn  
    )    
    END TRY  
      BEGIN CATCH        
        IF @@TRANCOUNT > 0        
        BEGIN        
            ROLLBACK TRANSACTION MySavePoint;         
        END        
      END CATCH                                                   
     COMMIT TRANSACTION                                                    
END
GO
