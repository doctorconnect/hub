
CREATE PROCEDURE [dbo].[uspDeletePost]  
(   
@PostId INT,
@Identifier VARCHAR(10),
@CreatedOn DateTime                                                       
)                                                      
AS                                                      
BEGIN        
    BEGIN TRANSACTION;      
      SAVE TRANSACTION MySavePoint;        
        BEGIN TRY  
			DEClARE @UserName VARCHAR(50) = NULL,
			@UserCode VARCHAR(50) = NULL,
			@ActionIdentifier NVARCHAR(50)

			IF(@Identifier='POST')
			BEGIN
			    SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Posts WHERE PostId = @PostId))
				SET @UserCode = (SELECT UserCode FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Posts WHERE PostId = @PostId))
				SET @ActionIdentifier = 'PostDelete'

				INSERT INTO KMTNotification(RoleId,	UserCode,IsAdminFlag,IsUserFlag,IsFacilitatorFlag,Identifier,AdminDescripation,UserDescripation,CreatedOn)
   				VALUES('1,10,12',@UserCode,0,0,0,@ActionIdentifier,'<b>' + @UserName + '</b>''s post <b>'+ (SELECT [Message] FROM Posts WHERE PostId = @PostId) + '</b> has been deleted','Your flagged post <b>'+ (SELECT [Message] FROM Posts WHERE PostId = @PostId) 
+ '</b> has been deleted',@CreatedOn)
            END

			ELSE IF(@Identifier='BLOG')
			BEGIN
				SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Blogs WHERE Id = @PostId))
				SET @UserCode = (SELECT UserCode FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Blogs WHERE Id = @PostId))
				SET @ActionIdentifier = 'BlogDelete'
				
				INSERT INTO KMTNotification(RoleId,	UserCode,IsAdminFlag,IsUserFlag,IsFacilitatorFlag,Identifier,AdminDescripation,UserDescripation,CreatedOn)
   				VALUES('1,10,12',@UserCode,0,0,0,@ActionIdentifier,'<b>' + @UserName + '</b>''s blog <b>'+ (SELECT Title FROM Blogs WHERE Id = @PostId) +'</b> has been deleted','Your blog <b>'+ (SELECT Title FROM Blogs WHERE Id = @PostId) + '</b> has been deleted'
 ,@CreatedOn)
			END

			ELSE IF(@Identifier='DOC')
			BEGIN
				SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM UploadDocument WHERE Id = @PostId))
				SET @UserCode = (SELECT UserCode FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM UploadDocument WHERE Id = @PostId))
			    SET @ActionIdentifier = 'DocDelete'

				INSERT INTO KMTNotification(RoleId,	UserCode,IsAdminFlag,IsUserFlag,IsFacilitatorFlag,Identifier,AdminDescripation,UserDescripation,CreatedOn)
   				VALUES('1,10,12',@UserCode,0,0,0,@ActionIdentifier,'<b>' + @UserName + '</b>''s document <b>'+ (SELECT Title FROM UploadDocument WHERE Id = @PostId) +'</b> has been deleted','Your document <b>'+ (SELECT Title FROM UploadDocument WHERE Id = @PostId)
 +'</b> has been deleted',@CreatedOn)
			END
		   
			 IF(@Identifier='POST') 
	 		 BEGIN  
			 DELETE FROM Postlikes WHERE PostId = @PostId;
			 DELETE FROM PostComments WHERE PostId = @PostId;
			 DELETE FROM Posts WHERE PostId = @PostId;
			 DELETE FROM [KMTPointEarnSystem] WHERE Pes_Id = @PostId;
			END	

			ELSE IF(@Identifier='BLOG') 
	 		 BEGIN  
			 DELETE FROM Postlikes WHERE PostId = @PostId;
			 DELETE FROM PostComments WHERE PostId = @PostId;
			 DELETE FROM blogs WHERE id = @PostId;
			 DELETE FROM [KMTPointEarnSystem] WHERE Pes_Id = @PostId;
			END

			ELSE IF(@Identifier='DOC') 
	 		 BEGIN 
			 DELETE FROM Postlikes WHERE PostId = @PostId;
			 DELETE FROM PostComments WHERE PostId = @PostId;
			 DELETE FROM [UploadDocument] WHERE id = @PostId;
			 DELETE FROM [KMTPointEarnSystem] WHERE Pes_Id = @PostId;
			END
				
        END TRY       
        BEGIN CATCH      
          IF @@TRANCOUNT > 0      
           BEGIN      
             ROLLBACK TRANSACTION MySavePoint;       
        END      
      END CATCH                                                 
     COMMIT TRANSACTION                                                  
END
GO
