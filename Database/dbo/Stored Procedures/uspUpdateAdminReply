
CREATE PROCEDURE [dbo].[uspUpdateAdminReply]  
(     
 @FeedBackId VARCHAR(50),      
 @AdminReply VARCHAR(500),      
 @ModifiedBy VARCHAR(50),      
 @ModifiedOn DATETIME      
)       
AS      
  BEGIN      
    BEGIN TRANSACTION;                      
     SAVE TRANSACTION MySavePoint;                        
      BEGIN TRY               
       UPDATE KMTFeedback     
	   SET AdminReply = @AdminReply,    
	   ModifiedBy = @ModifiedBy,     
	   ModifiedOn = @ModifiedOn      
       WHERE FeedbackId = @FeedBackId  
		
       DECLARE @UserCode VARCHAR(50), @AdminUser VARCHAR(50), @UserName VARCHAR(50)
	   SET @UserCode = (SELECT UserCode FROM KMTFeedback WHERE FeedbackId = @FeedBackId)
	   SET @UserName = (SELECT UserName FROM KMTFeedback WHERE FeedbackId = @FeedBackId)
	   SET @AdminUser = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = @ModifiedBy)

	   INSERT INTO KMTNotification(
		 RoleId,
		 UserCode,
		 IsAdminFlag,
		 IsUserFlag,
		 IsFacilitatorFlag,
		 Identifier,
		 AdminDescripation,
		 UserDescripation,
		 CreatedOn)

		 VALUES(
		 '1,12',
		 @UserCode,
		 0,
		 0,
		 0,
		 'Feedback reply',
		 '<b>' + @AdminUser + '</b> has replied on <b>' + @UserName + '</b>'' s feedback',
		 '<b>' + @AdminUser + '</b> has replied on your submitted feedback',
		 @ModifiedOn)    
      END TRY      
   BEGIN CATCH      
     IF @@TRANCOUNT > 0                      
        BEGIN                      
            ROLLBACK TRANSACTION MySavePoint;                       
        END                
      END CATCH                
    COMMIT TRANSACTION                
  END
GO
