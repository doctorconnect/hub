
CREATE PROCEDURE [dbo].[uspGetRegisteredUsersReports]        
(      
@StartDate DateTime,      
@EndDate DateTime,      
@Criteria Varchar(50),
@Capid int,
@CapText Varchar(10)
)      
AS 
 IF @CapText IS NULL 
 BEGIN             
BEGIN      
 IF @Criteria='Month-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(YEAR, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1  AND CapabilitiesId =@Capid  
   GROUP BY DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn)      
 END    
 ELSE IF @Criteria='Week-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(YEAR, CreatedOn), ' Week', DATEPART(WEEK, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1   AND CapabilitiesId =@Capid    
   GROUP BY DATEPART(WEEK, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(WEEK, CreatedOn)      
 END    
 ELSE IF @Criteria='Day-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(DAY, CreatedOn),'/',DATEPART(YEAR, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1   AND CapabilitiesId =@Capid  
   GROUP BY DATEPART(DAY, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(DAY, CreatedOn)    
 END    
 ELSE    
 BEGIN    
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(DAY, CreatedOn),'/',DATEPART(YEAR, CreatedOn), ' ',DATEPART(HOUR, CreatedOn), ':00')  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1    AND CapabilitiesId =@Capid  
   GROUP BY DATEPART(HOUR, CreatedOn),    
     DATEPART(DAY, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)    
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(DAY, CreatedOn), DATEPART(HOUR, CreatedOn)    
 END     
END
END
 IF @CapText='ALL'
 BEGIN 
 BEGIN 
 IF @Criteria='Month-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(YEAR, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1  
   GROUP BY DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn)      
 END    
 ELSE IF @Criteria='Week-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(YEAR, CreatedOn), ' Week', DATEPART(WEEK, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1    
   GROUP BY DATEPART(WEEK, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(WEEK, CreatedOn)      
 END    
 ELSE IF @Criteria='Day-wise'    
 BEGIN      
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(DAY, CreatedOn),'/',DATEPART(YEAR, CreatedOn))  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1   
   GROUP BY DATEPART(DAY, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)     
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(DAY, CreatedOn)    
 END    
 ELSE    
 BEGIN    
   SELECT     
   CONCAT(DATEPART(MONTH, CreatedOn),'/',DATEPART(DAY, CreatedOn),'/',DATEPART(YEAR, CreatedOn), ' ',DATEPART(HOUR, CreatedOn), ':00')  AS Interval,     
   COUNT(*) AS Utilization      
   FROM KMTUserRegistration             
   WHERE  CreatedOn>=@StartDate AND CreatedOn<=@EndDate  +1   
   GROUP BY DATEPART(HOUR, CreatedOn),    
     DATEPART(DAY, CreatedOn),    
     DATEPART(MONTH, CreatedOn),    
     DATEPART(YEAR, CreatedOn)    
   ORDER BY DATEPART(YEAR, CreatedOn), DATEPART(MONTH, CreatedOn), DATEPART(DAY, CreatedOn), DATEPART(HOUR, CreatedOn)    
 END 
 END
 END


GO
