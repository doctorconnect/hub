
CREATE PROCEDURE [dbo].[uspGetPopulerBlogList]     
   (
 @CapabilitiesId int,
 @IsAdmin int
 )                
AS    
 BEGIN    
 BEGIN TRANSACTION;          
 SAVE TRANSACTION MySavePoint;            
 BEGIN TRY
 if(@IsAdmin=0)            
 BEGIN      
   select P.Id,
   P.Message,
   R.username  as BlogBy,
   R.UserCode 
   from Blogs P join KMTUserRegistration R on R.id= P.BlogBy
   where P.Id  in (select a.pes_id from (
   select top(5) sum(points) as points, pes_id from [dbo].[KMTPointEarnSystem] 
   where Pes_type like '%Blog%' group by pes_id order by points desc)a)
    and P.CapId =  @CapabilitiesId     
   END
   if(@IsAdmin=1)            
 BEGIN      
   select P.Id,
   P.Message,
   R.username  as BlogBy,
   R.UserCode 
   from Blogs P join KMTUserRegistration R on R.id= P.BlogBy
   where P.Id  in (select a.pes_id from (
   select top(5) sum(points) as points, pes_id from [dbo].[KMTPointEarnSystem] 
   where Pes_type like '%Blog%' group by pes_id order by points desc)a)
   order by P.BlogDate desc        
   END
   END TRY    
   BEGIN CATCH    
      IF @@TRANCOUNT > 0          
     BEGIN          
            ROLLBACK TRANSACTION MySavePoint;           
        END    
         END CATCH    
    COMMIT TRANSACTION    
 END
GO
