
CREATE PROCEDURE [dbo].[uspUpdateBlogStatus]    
(@Id INT,
 @Remarks VARCHAR(250), 
 @ApproveBy VARCHAR(50),   
 @Approvedate DATETIME
 )
AS
 BEGIN    
    BEGIN TRANSACTION;          
     SAVE TRANSACTION MySavePoint;      
	 DEClARE @UserName VARCHAR(50) = NULL,
	   @UserCode VARCHAR(50) = NULL,
	   @AdminUser VARCHAR(50)

	   SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Blogs WHERE Id = @Id))  
	   SET @UserCode = (SELECT UserCode FROM KMTUserRegistration WHERE UserNTID = (SELECT CreatedBy FROM Blogs WHERE Id = @Id))  
	   SET @AdminUser = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = @ApproveBy)  
     
      BEGIN TRY   
        BEGIN  
             UPDATE Blogs SET [Status] = '1',Remarks = @Remarks,ApproveBy = @ApproveBy,Approvedate = @Approvedate WHERE id=@Id 
			 INSERT INTO KMTNotification(RoleId,UserCode,IsAdminFlag,IsUserFlag,IsFacilitatorFlag,Identifier,AdminDescripation,UserDescripation,CreatedOn) 
			 VALUES('1,10,12',@UserCode,0,0,0,'BlogApproval','<b>' + @AdminUser + '</b> has approved user blog <b>' + (SELECT Title FROM Blogs WHERE Id = @Id) + '</b>','Your blog has been approved by <b>'+ @AdminUser +'</b>', @Approvedate);                    
        END       
      END TRY    
   BEGIN CATCH    
      IF @@TRANCOUNT > 0          
     BEGIN          
            ROLLBACK TRANSACTION MySavePoint;           
        END    
         END CATCH    
    COMMIT TRANSACTION    
 END


GO
