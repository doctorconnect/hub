USE [KMT]

CREATE PROC [dbo].[uspCreatePoll](
@Title VARCHAR(MAX), 
@Options VARCHAR(100),
@FromDate DATETIME ,
@ToDate DATETIME ,
@IsActive BIT null =0,
@CreatedBy VARCHAR(50),
@CreatedOn DATETIME ,
@ModifiedBy VARCHAR(50) =null,
@ModifiedOn DATETIME =null
)
AS
	BEGIN
	 BEGIN TRANSACTION;      
      SAVE TRANSACTION MySavePoint;        
	    BEGIN TRY 
			INSERT INTO [dbo].[Poll] (Title,Options,FromDate,ToDate,IsActive,CreatedBy,Createdon,ModifiedBy,ModifiedOn) 
			VALUES(@Title,@Options,@FromDate,@ToDate,@IsActive,@CreatedBy,@CreatedOn, @ModifiedBy,@ModifiedOn)

			DEClARE @UserName VARCHAR(50) = NULL,
			@UserCode VARCHAR(50) = NULL

			SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserNTID = @CreatedBy)
		    SET @UserCode = (SELECT UserCode FROM KMTUserRegistration WHERE UserNTID = @CreatedBy)

			INSERT INTO KMTNotification(RoleId,	UserCode,IsAdminFlag,IsUserFlag,IsFacilitatorFlag,Identifier,AdminDescripation,UserDescripation,CreatedOn)
   			VALUES('1,10',@UserCode,0,0,0,'PollCreation','<b>' + @UserName + '</b> has created poll <b>'+ @Title + '</b>',NULL,@CreatedOn)

		END TRY
      BEGIN CATCH      
        IF @@TRANCOUNT > 0      
        BEGIN      
            ROLLBACK TRANSACTION MySavePoint;       
        END      
      END CATCH                                                 
     COMMIT TRANSACTION
	END
GO
