
CREATE PROCEDURE [dbo].[uspSubmitDocument]  
(                               
 @UPLOADBY INT,
 @CapId int ,
 @CreatedBy VARCHAR(50),
 @Message VARCHAR(50),
 @TYPE VARCHAR(50),
 @NAME VARCHAR(50),
 @FilePath VARCHAR(50),
 @Title VARCHAR(50),
 @Category VARCHAR(50),
 @STATUS INT,
 @Points  VARCHAR(10),
 @UserCode VARCHAR(50),
 @CreatedOn DATETIME                                   
)                                                      
AS                                                      
BEGIN        
    BEGIN TRANSACTION;      
      SAVE TRANSACTION MySavePoint;        
     BEGIN TRY  
	 BEGIN 
		INSERT INTO UPLOADDOCUMENT (
		[MESSAGE],
		[NAME],
		[TYPE],
		UPLOADBY,
		[STATUS],
		FilePath,
		UPLOADDATE,
		Title,
		Category,
		CreatedBy,
		CapId)  

		VALUES (
		@MESSAGE,
		@NAME,
		@TYPE,
		@UPLOADBY,
		@STATUS,
		@FilePath,
		GETDATE(),
		@Title,
		@Category,
		@CreatedBy,
		@CapId);

	   INSERT INTO KMTPointEarnSystem ( 
		Points,
		Pes_Id,
		Pes_type,
		Pes_by,
		Pes_On)

		VALUES ( 
		@Points,
		0,
		'UploadDoc',
		@CreatedBy,
		GETDATE());
        
		DEClARE @UserName VARCHAR(50) = NULL
		SET @UserName = (SELECT UserName FROM KMTUserRegistration WHERE UserCode = @UserCode )
		INSERT INTO KMTNotification(
		RoleId,
		UserCode,
		IsAdminFlag,
        IsUserFlag,
        IsFacilitatorFlag,
		Identifier,
		AdminDescripation,
		UserDescripation,
		CreatedOn)

		VALUES(
		'1,10,12',
		@UserCode,
		0,
		0,
		0,
		'DocumentApproval',
		'<b>' + @UserName + '</b> has uploaded new document <b>'+ @Title + '</b>',
		'Your document <b>'+ @Title + '</b> has been uploaded successfully',
		@CreatedOn)  

	 END           			                    
     END TRY   
     BEGIN CATCH
        IF @@TRANCOUNT > 0
        BEGIN
            ROLLBACK TRANSACTION MySavePoint;
        END  
      END CATCH                                         
     COMMIT TRANSACTION
END
GO
